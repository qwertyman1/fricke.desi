<!DOCTYPE html> 
<html>
<head>
    <title>Desirée</title>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Cormorant|Work+Sans" rel="stylesheet">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-size: 14px;
            font-size: 2vw;
        }
        body {
            background: #0e0e0e;
            color: #fff;
            font-family: 'Work Sans', sans-serif;
        }
        h1, h2, h3, h4, h5 {
            color:#fff;
            font-weight: normal;
            text-align: center;
        }

        h1 {
            font-size: 3em;
            margin: 0.4vw 0 0.2vw 0;
            font-family: 'Cormorant', serif;
        }

        h2 {
            font-size: 1.5em;
            margin: 0.2vw 0;
        }

        h3 {
            font-size: 1em;
            margin: 0.2vw 0;
        }

        div.birthday {
            width: 100%;
        } 
        #images {
            width: 100%;
            margin-top:4vw;
        }

        #images div {
            margin: 0 0 4vw 0;
            width: 100%;
        }

        #images div img {
            width: 100%;
            margin: 0;
            image-orientation: from-image;
            display:block;
        }
        #images div span {
            margin: 1vw 1vw 2vw 0;
            text-transform: uppercase;
            display:block;
            /*font-family: 'Cormorant', serif;*/
        }



        img.rot-1 {
            /*-webkit-transform: rotate(90deg);
            -moz-transform: rotate(90deg);
            -o-transform: rotate(90deg);
            -ms-transform: rotate(90deg);
            
            transform-origin: center center;
            position: relative;
            transform: rotate(90deg);
            height: calc(100vw-10px);
            image-orientation: 90deg;*/
        }

    </style>
        
</head>

<body>
    <div class="birthday">

        <input type="text" id="debugger" style="display:none;" placeholder="Enter new date (yyyy-mm-dd)" />

        <h1>Desirée is</h1>
        <h2><span id="fullAge"></span></h2>
        <h3><span id="months"></span><span id="days"></span></h3>
        <h3 id="days"></h3>
    </div>

    <div id="images"></div>


    <script>

        (function () {

            //Shortcut for getting elements from DOM
            window.$ = function (str) {
                if (str && str.length > 0) {
                    if (str[0] === "#") {
                        return document.getElementById(str.substring(1))
                    } else {
                        return document.querySelector(str);
                    }
                }
                return undefined;
            };

            window.$.qs = function () {
                if (window.$._qs)
                    return window.$._qs;
                else {
                    var arr = location.search.replace('?', '').split('&');
                    var obj = {};

                    for (var i = 0; i < arr.length; i++) {
                        var name = arr[i].split('=')[0];
                        var value = arr[i].split('=')[1];
                        obj[name] = value;
                    }
                    window.$._qs = obj;
                    return obj;
                }
            };

            //Date calculator and format helper
            var dateFormat = {
                
                totalTime: function (from, to) {
                    
                    var items = [];


                    //Get all units
                    var units = [
                        { unit: 'years', strSingle: ' year', strMultiple: ' years' },
                        { unit: 'months', strSingle: ' month', strMultiple: ' months' },
                        { unit: 'days', strSingle: ' day', strMultiple: ' days' },
                        { unit: 'hours', strSingle: ' hour', strMultiple: ' hours' },
                        { unit: 'minutes', strSingle: ' minute', strMultiple: ' minutes' },
                        { unit: 'seconds', strSingle: ' second', strMultiple: ' seconds' },
                    ];
                    
                    for (var i in units) {
                        var item = units[i];

                        var amount = to.diff(from, item.unit);
                        if (amount > 0) {
                            var text = dateFormat._formatNumber(amount, item.strSingle, item.strMultiple);
                            items.push(text);
                            from = from.clone().add(amount, item.unit);
                        }
                    }

                    //build string
                    var strTotal = "";
                    if (items.length > 0) {
                        var last = undefined;
                        if (items.length > 1) {
                            last = items[items.length - 1];
                            items.splice(items.length - 1, 1);
                        }
                        strTotal = items.join(", ");
                        if (last) {
                            strTotal += " and " + last;
                        }
                    }

                    return strTotal;
                },

                totalMonths: function (from, to) {

                    var months = to.diff(from, 'months');
                    return this._formatNumber(months, " month", " months");
                },
                totalDays: function (from, to) {
                    var days = to.diff(from, 'days');
                    return this._formatNumber(days, " day", " days");
                },
                
                readableTimespamp: function (from, now) {
                    var strReturn = "";
                    now = now || new moment();

                    if (from) {
                        var diffMs = now.diff(from);

                        if (diffMs < 0) {
                            strReturn += "In the future";
                        }
                        else if (diffMs > 1000 * 60 * 60 * 24 * 7) { // more than a week 

                            var date = from.date();
                            var month = from.format("MMMM");
                            var year = from.year();

                            strReturn += date + " " + month;
                            if (moment().year() != year)
                                strReturn += " " + year;
                        }
                        else {
                            strReturn += from.fromNow();
                        }
                    }

                    
                    return strReturn;
                },

                _formatNumber: function (number, singular, plural) {
                    if (number == 0) {
                        return "";
                    }

                    var str = "";
                    if (number == 1) {
                        str = singular;
                    }
                    else {
                        str = plural;
                    }
                    return number + str;
                },

            };

            var birthdayHandler = {
                _unixBirthday: 1466891160, //Dessie
                //_unixBirthday: 523843200, //Huining

                _birthday: function () { return moment.unix(this._unixBirthday) },

                _updateUi: function (from, to) {
                    var fullAge = dateFormat.totalTime(from, to);
                    var totalMonths = dateFormat.totalMonths(from, to);
                    var totalDays = dateFormat.totalDays(from, to);
                    
                    //Update UI
                    $("#fullAge").innerText = fullAge + " old"
                    $("#months").innerText = "Total of " + totalMonths;
                    $("#days").innerText = ", or " + totalDays + " old";
                    
                },
                
                //Main function
                update: function () {
                    var now = moment();
                    this._updateUi(this._birthday(), now);
                },
            };

            var exifHelper = {
                getDate: function (exifDate) {
                    if (!exifDate)
                        return undefined;
                    var datStr = this._replaceAt(this._replaceAt(this._replaceAt((exifDate), 4, "-"), 7, "-"), 10, "T");
                    return new Date(datStr);

                },
                getMoment: function (exifDate) {
                    if (!exifDate)
                        return undefined;
                    var datStr = this._replaceAt(this._replaceAt(this._replaceAt((exifDate), 4, "-"), 7, "-"), 10, "T");
                    return moment(datStr);

                },
                //String helper methods
                _replaceAt: function (str, index, replacement) {
                    return str.substr(0, index) + replacement + str.substr(index + replacement.length);
                },
            }

            var imageCreator = {
                //DOM helper methods
                createElement: function (item) {
                    var img = this._createImage("https://drive.google.com/uc?export=view&id=" + item.id, 'rot-' + item.imageMediaMetadata.rotation, '', '');

                    //Set height relative to viewport 
                    var w = item.imageMediaMetadata.width;
                    var h = item.imageMediaMetadata.height;
                    let newImgHeight;
                    if (item.imageMediaMetadata.rotation == 0 || item.imageMediaMetadata.rotation == 2) {
                        newImgHeight = Math.floor(h / w * 100);
                    }
                    else {
                        newImgHeight = Math.floor(w / h * 100);
                    }
                    img.style.minHeight = newImgHeight + "vw";


                    var span = document.createElement("span");
                    var date = exifHelper.getMoment(item.imageMediaMetadata.date);
                    var text = dateFormat.readableTimespamp(date);
                    span.innerText = text;

                    var el = document.createElement("div");
                    el.appendChild(img);
                    el.appendChild(span);
                    return el;
                },

                _createImage: function (src, cssClass, alt, title) {
                    var img = document.createElement('img') || new Image();
                    img.src = src;
                    if (alt != null) img.alt = alt;
                    if (title != null) img.title = title;
                    if (cssClass != null) img.className = cssClass;
                    return img;
                },

                _createEmptyImage: function (id, cssClass) {
                    var img = document.createElement('img') || new Image();
                    img.setAttribute("id", id);
                    
                    if (cssClass != null) img.className = cssClass;
                    return img;
                },

                
            };
            
            var imageFetcher = {

                _key: "AIzaSyAM9XqhZGri07KQXdtioOGIsHzc2guR0V4",
                _url: "https://www.googleapis.com/drive/v2/files?q='0B-hMc6XvBKsXanc3Z1UzTUJYZkE'+in+parents+and+mimeType='image/jpeg'&orderBy=createdDate+desc&key=AIzaSyAM9XqhZGri07KQXdtioOGIsHzc2guR0V4",

                _status: function (response) {
                    if (response.status >= 200 && response.status < 300) {
                        return Promise.resolve(response)
                    } else {
                        return Promise.reject(new Error(response.statusText))
                    }
                },

                _retry: function (response) {
                    if (response.status >= 200 && response.status < 300) {
                        return Promise.resolve(response)
                    } else {
                        return Promise.reject(new Error(response.statusText))
                    }
                },

                _json: function (response) {
                    return response.json()
                },

                _handleResponse: async function (data) {
                    //Sort by date taken desc
                    var items = data.items;
                    items.sort(imageFetcher._sortImageTakenDesc); //Don't use 'this' in callback

                    //Add images for each item
                    for (var i in items) {
                        var item = items[i];
                        var element = imageCreator.createElement(item);
                        $("#images").appendChild(element);
                        await imageFetcher._sleep(15); //Fetch sequentially. 
                    }
                },


                _sleep: function (ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                },

                

                _sortImageTakenDesc: function (a, b) {
                    var datA = exifHelper.getDate(a.imageMediaMetadata.date) || new Date("1990-01-01 00:00:00");
                    var datB = exifHelper.getDate(b.imageMediaMetadata.date) || new Date("1990-01-01 00:00:00");
                    return datB.getTime() - datA.getTime();
                },


                //Fetch helper methods
                fetchImages: function () {
                    fetch(this._url, { mode: 'cors' })
                        .then(this._status)
                        .then(this._json)
                        .then(this._handleResponse)
                        .catch(function (err) {
                            console.log('Fetch Error', err);
                        });
                },

            };

            birthdayHandler.update();
            setInterval(function () { birthdayHandler.update() }, 1000);

            imageFetcher.fetchImages();

            //Allow changing birthday for debugging reasons
            if ($.qs()["debug"] === "1") {
                document.addEventListener('DOMContentLoaded', function () {
                    $('input[id="debugger"]').onchange = changeEventHandler;
                    $('input[id="debugger"]').style.display = "block";
                }, false);

                function changeEventHandler(event) {
                    // You can use “this” to refer to the selected element.
                    var date = new Date(event.target.value);
                    if (date) {
                        birthdayHandler._unixBirthday = Math.floor(date.getTime() / 1000);
                        console.log("Birthday updated: " + date.toISOString().slice(0, 10));
                    }
                }
            }

        })();

    </script>


</body>

</html>

